<script>
  const WEBHOOK_URL = "https://hooks.xn--h32b21du9cf7grcy2k20f.com/webhook/ask";

  const $ = (s)=>document.querySelector(s);
  const q = $('#q');
  const btn = $('#send');
  const res = $('#res');
  const sendLabel = $('#sendLabel');

  function loading(on){
    if(on){ btn.disabled = true; sendLabel.innerHTML = '<span class="spin"></span>'; }
    else { btn.disabled = false; sendLabel.textContent = 'Send'; }
  }

  async function postJson(url, body){
    const r = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const text = await r.text();
    let data; try{ data = JSON.parse(text); }catch{ data = { raw:text }; }
    return { ok:r.ok, status:r.status, data };
  }

  async function send(){
    const query = q.value.trim();
    if(!query){ q.focus(); return; }
    res.textContent = '';
    loading(true);
    try{
      // n8n 쪽에 기대 필드명 맞추기
      const payload = { keyword: query };
      const r = await postJson(WEBHOOK_URL, payload);

      if(!r.ok){
        // ← 백틱으로 템플릿 문자열
        res.textContent = `HTTP ${r.status}\n` + JSON.stringify(r.data, null, 2);
        return;
      }

      const ans = r.data?.answer ?? r.data?.data ?? r.data?.raw ?? r.data;
      // n8n이 HTML을 직접 주면 그대로 렌더링하고 싶다면 아래 3줄로 교체:
      // document.open('text/html','replace'); document.write(ans); document.close(); return;

      res.textContent = (typeof ans === 'string') ? ans : JSON.stringify(ans, null, 2);
    }catch(e){
      res.textContent = String(e);
    }finally{
      loading(false);
    }
  }

  btn.addEventListener('click', send);
  q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

  // helper chips click
  (function(){
    const box = document.getElementById('helpers');
    const chips = Array.from(box.children);
    for (let i = chips.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      box.appendChild(chips[j]);
    }
    chips.forEach((c, idx)=>{ c.style.display = idx < 3 ? 'inline-block' : 'none'; });
    box.addEventListener('click', (e)=>{
      const el = e.target.closest('.helper'); if(!el) return;
      q.value = el.getAttribute('data-text') || '';
      q.focus();
    });
  })();
</script>
