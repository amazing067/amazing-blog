<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì–´ë©”ì´ì§•ì‚¬ì—…ë¶€ ë¸”ë¡œê·¸ ìë™í™”</title>
  <style>
    :root{ --bg1:#f8fbff; --bg2:#fff7fd; --ink:#111827; --ring:#9b87f5; --accent:#7c3aed; --accent2:#9b87f5; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 12% -8%, var(--bg2), transparent 60%),
        radial-gradient(900px 600px at 108% 8%, #eaf2ff, transparent 55%),
        linear-gradient(180deg, var(--bg1), #fff);
      display:grid;place-items:center;padding:28px;
    }
    .wrap{width:100%;max-width:860px}
    .hero{ text-align:center; margin-bottom:14px; }
    .sticker{
      width:74px;height:74px;margin:0 auto 10px; border-radius:18px;display:grid;place-items:center;overflow:hidden;
      background:linear-gradient(135deg,#fef3c7,#fde68a);border:1px solid #fcd34d;
      box-shadow:inset 0 0 0 3px #ffffffb8,0 10px 26px #f59e0b33;
    }
    .title{
      font-size:28px; font-weight:900; margin:0;
      background:linear-gradient(90deg,#7c3aed,#22d3ee,#7c3aed);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      background-size:200% 100%; animation:shine 4s linear infinite;
      letter-spacing:-0.3px;
    }
    @keyframes shine{0%{background-position:0% 50%}100%{background-position:200% 50%}}
    .card{
      background:#ffffffcc;border:1px solid #eef2ff;border-radius:22px;backdrop-filter:blur(8px);
      box-shadow:0 12px 34px #00000012;padding:20px 18px 16px;
    }
    .ask{
      display:flex;align-items:center;gap:8px;background:#fff;border:1.5px solid #e5e7eb;
      border-radius:999px;padding:10px 10px 10px 14px; box-shadow:0 2px 8px #00000008;
      transition:box-shadow .2s,border .2s;
    }
    .ask:focus-within{border-color:var(--ring); box-shadow:0 0 0 4px #9b87f522}
    .ask input{
      flex:1;border:0;outline:none;font-size:15px;background:transparent;
      padding:6px 2px; min-height:22px;
    }
    .send{
      border:0;cursor:pointer; padding:10px 14px;border-radius:999px;color:#fff;
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      box-shadow:0 8px 18px #7c3aed33, inset 0 -6px 12px #00000014;
      display:inline-flex;align-items:center;gap:8px;font-weight:700;
      transition:transform .06s, filter .15s;
    }
    .send:hover{filter:brightness(1.04)}
    .send:active{transform:translateY(1px)}
    .send[disabled]{opacity:.65;cursor:not-allowed}
    .spin{width:16px;height:16px;border-radius:50%;border:2px solid #ffffff80;border-top-color:#fff;display:inline-block;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .helpers{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center}
    .helper{ font-size:12px;border:1px dashed #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer; }
    .helper:hover{border-color:#c7d2fe}
    .res{
      margin-top:14px;background:#fff;border:1px solid #eef2ff;border-radius:16px;padding:14px;min-height:130px;
      white-space:pre-wrap;line-height:1.6
    }
    .placeholder{color:#9ca3af;font-size:14px}
    .status{
      display:flex;align-items:center;gap:10px;font-weight:800;
      background:linear-gradient(90deg,#7c3aed,#22d3ee,#7c3aed);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      background-size:200% 100%;animation:shine 3s linear infinite;
    }
    .test-indicator{position:fixed;top:10px;right:10px;background:#ff6b35;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;z-index:1000;}

    /* ===== Generator sections ===== */
    .gen-wrap{margin-top:18px}
    .gen-title{font-size:20px;font-weight:900;margin:0 0 8px}
    .gen-card{background:#ffffffcc;border:1px solid #eef2ff;border-radius:18px;padding:16px;box-shadow:0 10px 26px #00000010}
    .gen-row{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:740px){ .gen-row{grid-template-columns:1.2fr .8fr} }
    .gen-label{display:block;font-size:12px;color:#6b7280;margin-bottom:6px}
    .gen-input, .gen-url{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;color:#111827;outline:none
    }
    .gen-hint{font-size:12px;color:#8892a6;margin-top:6px}
    .gen-row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .gen-switch{display:flex;align-items:center;gap:8px}
    .gen-small{font-size:12px}
    .gen-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;color:#111827;cursor:pointer}
    .gen-btn.primary{border-color:#2b4a7a;background:linear-gradient(180deg,#1a3a6d,#132a4f);color:#eaf2ff}
    .gen-out{word-break:break-all;background:#0f1421;color:#e7e9ee;border:1px dashed #2a3550;border-radius:12px;padding:12px;margin-top:10px}
    .gen-pill{display:inline-block;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;color:#6b7280;font-size:12px;margin-top:8px}
    .gen-grid{display:grid;gap:16px}
    @media (min-width:860px){ .gen-grid{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="sticker" aria-hidden="true">
        <svg viewBox="0 0 80 80" width="58" height="58">
          <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#fef3c7"/><stop offset="1" stop-color="#fde68a"/></linearGradient></defs>
          <circle cx="40" cy="40" r="28" fill="url(#g)" stroke="#fbbf24" stroke-width="2"/>
          <circle cx="32" cy="35" r="4" fill="#1f2937"/><circle cx="48" cy="35" r="4" fill="#1f2937"/>
          <path d="M28 49 Q40 58 52 49" stroke="#1f2937" stroke-width="3" fill="none" stroke-linecap="round"/>
          <path d="M18 26 26 18 M54 18 62 26" stroke="#f59e0b" stroke-width="3" stroke-linecap="round"/>
        </svg>
      </div>
      <h1 class="title">ì–´ë©”ì´ì§•ì‚¬ì—…ë¶€ ë¸”ë¡œê·¸ ìë™í™”</h1>
    </div>

    <div class="card">
      <div class="ask">
        <input id="q" autocomplete="off" placeholder="ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        <button id="send" class="send" type="button"><span id="sendLabel">Send</span> ğŸš€</button>
      </div>

      <div class="helpers" id="helpers">
        <button class="helper" data-text="ì‹¤ì†ë³´í—˜ ì²­êµ¬ ì„œë¥˜ ìš”ì•½í•´ì¤˜">ì‹¤ì† ì„œë¥˜ ìš”ì•½</button>
        <button class="helper" data-text="í•­ì•” ì¤‘ì…ì ì¹˜ë£Œ ë³´ì¥ í•µì‹¬ë§Œ ì•Œë ¤ì¤˜">ì¤‘ì…ìì¹˜ë£Œ í•µì‹¬</button>
        <button class="helper" data-text="ì¥ê¸°ìš”ì–‘ë³´í—˜ ë“±ê¸‰ë³„ ì°¨ì´ë¥¼ í‘œë¡œ ì •ë¦¬í•´ì¤˜">ì¥ê¸°ìš”ì–‘ í‘œì •ë¦¬</button>
        <button class="helper" data-text="ì•” ì£¼ìš”ì¹˜ë£Œë¹„ ë³´ì¥ í•­ëª©ì„ ê°„ë‹¨íˆ ì •ë¦¬í•´ì¤˜">ì•” ì£¼ìš”ì¹˜ë£Œë¹„ í•µì‹¬</button>
        <button class="helper" data-text="ë‡Œí˜ˆê´€Â·ì‹¬ì¥ì§ˆí™˜ ì§„ë‹¨ë¹„ ì°¨ì´ë¥¼ í•œ ë¬¸ë‹¨ìœ¼ë¡œ ì„¤ëª…í•´ì¤˜">ë‡Œì‹¬ ì§„ë‹¨ë¹„ ë¹„êµ</button>
        <button class="helper" data-text="ìœ ë³‘ì ë³´í—˜ 3.N.5 êµ¬ì¡°ë¥¼ ì´ˆë³´ììš©ìœ¼ë¡œ ì„¤ëª…í•´ì¤˜">3.N.5 ì„¤ëª…</button>
        <button class="helper" data-text="ìƒê¸‰ë³‘ì‹¤ íŠ¹ì•½ì´ ì‹¤ì œ ë³´ì¥ì— ì–´ë–¤ ì˜í–¥ì„ ì£¼ëŠ”ì§€ ì•Œë ¤ì¤˜">ìƒê¸‰ë³‘ì‹¤ íŠ¹ì•½</button>
        <button class="helper" data-text="ê°„ë³‘ì¸ ë³´í—˜ ì£¼ìš” ì¡°ê±´ê³¼ ì£¼ì˜í•  ì ë§Œ ëª¨ì•„ì¤˜">ê°„ë³‘ì¸ ë³´í—˜ í¬ì¸íŠ¸</button>
      </div>

      <div id="res" class="res"></div>
    </div>

    <!-- ===== Two Generators (A: Direct Kakao, B: Redirect via n8n) ===== -->
    <div class="gen-wrap" id="generator">
      <h2 class="gen-title">ì¹´ì¹´ì˜¤ ì±„ë„ ë§í¬ ìƒì„±ê¸° (ë‘ ê°€ì§€ ë°©ì‹)</h2>
      <div class="gen-grid">
        <!-- Generator A: Direct Kakao -->
        <div class="gen-card">
          <h3 class="gen-title" style="font-size:16px;margin-top:0">A) ì¹´ì¹´ì˜¤ ì±„ë„ì— ì§ì ‘ ì—°ê²°</h3>
          <label class="gen-label">ê¸°ë³¸ ì±„íŒ… ë§í¬ (ë¸Œë¼ìš°ì € ì €ì¥)</label>
          <div class="gen-row">
            <input id="genA-base" class="gen-url" type="url" placeholder="ì˜ˆ) http://pf.kakao.com/_JxmxaJn/chat" />
            <button class="gen-btn" id="genA-saveBase">ì €ì¥</button>
          </div>
          <div class="gen-hint">ì˜ˆ: http://pf.kakao.com/_JxmxaJn/chat</div>
          <div style="height:10px"></div>
          <div class="gen-row">
            <div>
              <label class="gen-label">í‚¤ì›Œë“œ (í•œê¸€ ê°€ëŠ¥)</label>
              <input id="genA-keyword" class="gen-input" type="text" placeholder="ì˜ˆ) ìˆ˜ìˆ ë¹„ë³´í—˜" />
            </div>
            <div>
              <label class="gen-label">ref ì§ì ‘ ì§€ì • (ì„ íƒ)</label>
              <input id="genA-customRef" class="gen-input" type="text" placeholder="ë¯¸ì…ë ¥ ì‹œ í‚¤ì›Œë“œ ì‚¬ìš©" />
            </div>
          </div>
          <div class="gen-row2" style="margin-top:6px">
            <div class="gen-switch">
              <input type="checkbox" id="genA-useUtm" />
              <label for="genA-useUtm" class="gen-small">UTM ì‚¬ìš©</label>
            </div>
            <div class="gen-switch">
              <input type="checkbox" id="genA-asciiRef" />
              <label for="genA-asciiRef" class="gen-small">ASCII ref (ì˜ë¬¸/ìˆ«ì/í•˜ì´í”ˆ)</label>
            </div>
          </div>
          <div class="gen-row" style="margin-top:8px">
            <div class="gen-row2">
              <div>
                <label class="gen-label">utm_source</label>
                <input id="genA-utmSource" class="gen-input" type="text" placeholder="ì˜ˆ) blog" />
              </div>
              <div>
                <label class="gen-label">utm_medium</label>
                <input id="genA-utmMedium" class="gen-input" type="text" placeholder="ì˜ˆ) referral" />
              </div>
            </div>
            <div>
              <label class="gen-label">utm_content</label>
              <input id="genA-utmContent" class="gen-input" type="text" placeholder="ë¯¸ì…ë ¥ ì‹œ ref ê°’ ì‚¬ìš©" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="gen-row2">
            <button class="gen-btn primary" id="genA-generate">ë§í¬ ìƒì„±</button>
            <button class="gen-btn" id="genA-copy">ë³µì‚¬</button>
          </div>
          <div class="gen-out" id="genA-output">ì—¬ê¸°ì— ìƒì„±ëœ ë§í¬ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
          <span class="gen-pill" id="genA-status">idle</span>
        </div>

        <!-- Generator B: Redirect via n8n -->
        <div class="gen-card">
          <h3 class="gen-title" style="font-size:16px;margin-top:0">B) n8n ë¦¬ë””ë ‰í„° ê²½ìœ  (ë¡œê·¸ ê¸°ë¡)</h3>
          <label class="gen-label">ë¦¬ë””ë ‰í„° ê¸°ë³¸ ë§í¬ (ë¸Œë¼ìš°ì € ì €ì¥)</label>
          <div class="gen-row">
            <input id="genB-base" class="gen-url" type="url" placeholder="ì˜ˆ) https://blog.ì–´ë©”ì´ì§•ì‚¬ì—…ë¶€.com/kakao-redirect" />
            <button class="gen-btn" id="genB-saveBase">ì €ì¥</button>
          </div>
          <div class="gen-hint">ì˜ˆ: https://blog.ì–´ë©”ì´ì§•ì‚¬ì—…ë¶€.com/kakao-redirect</div>
          <div style="height:10px"></div>
          <div class="gen-row">
            <div>
              <label class="gen-label">í‚¤ì›Œë“œ (í•œê¸€ ê°€ëŠ¥)</label>
              <input id="genB-keyword" class="gen-input" type="text" placeholder="ì˜ˆ) ìˆ˜ìˆ ë¹„ë³´í—˜" />
            </div>
            <div>
              <label class="gen-label">ref ì§ì ‘ ì§€ì • (ì„ íƒ)</label>
              <input id="genB-customRef" class="gen-input" type="text" placeholder="ë¯¸ì…ë ¥ ì‹œ í‚¤ì›Œë“œ ì‚¬ìš©" />
            </div>
          </div>
          <div class="gen-row2" style="margin-top:6px">
            <div class="gen-switch">
              <input type="checkbox" id="genB-useUtm" />
              <label for="genB-useUtm" class="gen-small">UTM ì‚¬ìš©</label>
            </div>
            <div class="gen-switch">
              <input type="checkbox" id="genB-asciiRef" />
              <label for="genB-asciiRef" class="gen-small">ASCII ref (ì˜ë¬¸/ìˆ«ì/í•˜ì´í”ˆ)</label>
            </div>
          </div>
          <div class="gen-row" style="margin-top:8px">
            <div class="gen-row2">
              <div>
                <label class="gen-label">utm_source</label>
                <input id="genB-utmSource" class="gen-input" type="text" placeholder="ì˜ˆ) blog" />
              </div>
              <div>
                <label class="gen-label">utm_medium</label>
                <input id="genB-utmMedium" class="gen-input" type="text" placeholder="ì˜ˆ) referral" />
              </div>
            </div>
            <div>
              <label class="gen-label">utm_content</label>
              <input id="genB-utmContent" class="gen-input" type="text" placeholder="ë¯¸ì…ë ¥ ì‹œ ref ê°’ ì‚¬ìš©" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="gen-row2">
            <button class="gen-btn primary" id="genB-generate">ë§í¬ ìƒì„±</button>
            <button class="gen-btn" id="genB-copy">ë³µì‚¬</button>
          </div>
          <div class="gen-out" id="genB-output">ì—¬ê¸°ì— ìƒì„±ëœ ë§í¬ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
          <span class="gen-pill" id="genB-status">idle</span>
        </div>
      </div>
    </div>
    <!-- ===== /Generators ===== -->

  </div>

<script>
  // Test mode
  function isTestMode() {
    return window.location.search.includes('test=true') || window.location.search.includes('debug=true');
  }
  const WEBHOOK_URL = isTestMode() ? "/webhook-test/ask" : "/webhook/ask";

  if (isTestMode()) {
    const indicator = document.createElement('div');
    indicator.className = 'test-indicator';
    indicator.textContent = 'TEST MODE';
    document.body.appendChild(indicator);
    console.log('Test mode enabled');
    console.log('Using webhook URL:', WEBHOOK_URL);
  }

  const $ = (s)=>document.querySelector(s);
  const q = $('#q'), btn = $('#send'), res = $('#res'), sendLabel = $('#sendLabel');
  res.innerHTML = '<div class="placeholder">ê²°ê³¼ëŠ” ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';

  function loading(on){
    if(on){
      btn.disabled = true;
      sendLabel.innerHTML = '<span class="spin"></span>';
      res.innerHTML = '<div class="status"><span class="spin"></span>Workingâ€¦</div>';
    } else {
      btn.disabled = false;
      sendLabel.textContent = 'Send';
    }
  }

  async function postJson(url, body){
    const r = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const text = await r.text();
    let data; try{ data = JSON.parse(text); } catch { data = { raw:text }; }
    return { ok:r.ok, status:r.status, data };
  }

  function looksLikeHtml(s){
    return /^\s*<(?:!DOCTYPE|html|body|main|div|section|article|h1|h2|p|iframe)\b/i.test(s || "");
  }
  function decodeHtmlEntities(str) {
    if (typeof str !== 'string') return str;
    const el = document.createElement("textarea");
    el.innerHTML = str;
    return el.value;
  }
  function extractEmbeddable(htmlString){
    try {
      const s = String(htmlString || "");
      if (/^\s*<iframe\b/i.test(s)) return s;
      const parser = new DOMParser();
      const doc = parser.parseFromString(s, 'text/html');
      const main = doc.querySelector('main');
      if (main) return main.innerHTML;
      if (doc.body) return doc.body.innerHTML || s;
      return s;
    } catch {
      return htmlString;
    }
  }
  function pickHtmlPayload(data, fallback){
    const candidates = [
      data?.html_document,
      data?.html,
      data?.content,
      data?.body,
      data?.answer?.html_document,
      data?.answer?.html,
      data?.data?.html_document,
      data?.data?.html,
      data?.json?.html_document,
      data?.json?.html,
      fallback
    ].filter(v => typeof v === 'string');

    for (let raw of candidates){
      const dec = /&lt;|&gt;|&amp;|&quot;|&#39;/.test(raw) ? decodeHtmlEntities(raw) : raw;
      if (looksLikeHtml(dec)) return dec;
    }
    return null;
  }
  function renderHtmlIntoResult(html){
    const cleaned = decodeHtmlEntities(html);
    const embeddable = extractEmbeddable(cleaned);
    res.innerHTML = embeddable;
    res.style.whiteSpace = 'normal';
    res.style.textAlign = 'left';
    res.style.display = 'block';
    res.style.minHeight = 'auto';
  }

  async function send(){
    const topic = q.value.trim();
    if(topic.length < 2){ q.focus(); res.textContent='Please enter at least 2 characters.'; return; }
    loading(true);
    try{
      const r = await postJson(WEBHOOK_URL, { topic });
      if(!r.ok){ res.textContent = `HTTP ${r.status}\n` + JSON.stringify(r.data,null,2); return; }

      const ans = r.data?.answer ?? r.data?.data ?? r.data?.raw ?? r.data ?? { ok:true };
      const html = pickHtmlPayload(r.data, typeof ans==='string' ? ans : '');
      if (html){
        renderHtmlIntoResult(html);
        return;
      }
      res.textContent = (typeof ans==='string') ? ans : JSON.stringify(ans,null,2);
    }catch(e){
      res.textContent = 'Network error: ' + (e?.message || String(e));
    }finally{
      loading(false);
    }
  }

  btn.addEventListener('click', send);
  q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

  (function(){
    const box = document.getElementById('helpers');
    const chips = Array.from(box.children);
    const shuffled = [...chips];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    shuffled.forEach(el => box.appendChild(el));
    shuffled.forEach((el, idx) => { el.style.display = idx < 3 ? 'inline-block' : 'none'; });
    box.addEventListener('click', (e)=>{
      const el = e.target.closest('.helper'); if(!el) return;
      q.value = el.getAttribute('data-text') || ''; q.focus();
    });
  })();

  /* ===== Generator A: Direct Kakao ===== */
  (function(){
    function toAsciiSlug(s) {
      return (s || "")
        .toString()
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^A-Za-z0-9\s\-_.]/g, " ")
        .replace(/[\s_]+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "")
        .toLowerCase()
        .slice(0, 80) || "ref";
    }
    const enc = (s)=>encodeURIComponent(s || "");

    function buildUrl(base, ref, useUtm, utmSource, utmMedium, utmContent) {
      if (!base) return "";
      const hasQ = base.includes("?");
      const join = hasQ ? "&" : "?";
      const q = [`ref=${enc(ref)}`];
      if (useUtm) {
        if (utmSource) q.push(`utm_source=${enc(utmSource)}`);
        if (utmMedium) q.push(`utm_medium=${enc(utmMedium)}`);
        q.push(`utm_content=${enc(utmContent || ref)}`);
      }
      return base + join + q.join("&");
    }

    const $base = document.getElementById("genA-base");
    const $saveBase = document.getElementById("genA-saveBase");
    const $keyword = document.getElementById("genA-keyword");
    const $customRef = document.getElementById("genA-customRef");
    const $useUtm = document.getElementById("genA-useUtm");
    const $asciiRef = document.getElementById("genA-asciiRef");
    const $utmSource = document.getElementById("genA-utmSource");
    const $utmMedium = document.getElementById("genA-utmMedium");
    const $utmContent = document.getElementById("genA-utmContent");
    const $genBtn = document.getElementById("genA-generate");
    const $copyBtn = document.getElementById("genA-copy");
    const $out = document.getElementById("genA-output");
    const $status = document.getElementById("genA-status");

    (function init(){
      const savedBase = localStorage.getItem("kakao_base_chat_link");
      if (savedBase) $base.value = savedBase;
      if (!$utmSource.value) $utmSource.value = "blog";
      if (!$utmMedium.value) $utmMedium.value = "referral";
      const onChange = ()=>live();
      [$keyword,$customRef,$useUtm,$asciiRef,$utmSource,$utmMedium,$utmContent].forEach(el=>{
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', onChange);
      });
      live();
    })();

    $saveBase.addEventListener("click", () => {
      const v = ($base.value || "").trim();
      if (!/^https?:\/\//i.test(v)) { alert("Enter a valid URL"); return; }
      localStorage.setItem("kakao_base_chat_link", v);
      $status.textContent = "base saved";
      setTimeout(()=>{$status.textContent="idle"}, 900);
      live();
    });

    function currentRef() {
      const raw = ($customRef.value || $keyword.value || "").trim();
      if (!raw) return "";
      if ($asciiRef.checked) return toAsciiSlug(raw);
      return raw;
    }

    function live() {
      const base = ($base.value || "").trim();
      const ref = currentRef();
      const url = buildUrl(
        base,
        ref,
        $useUtm.checked,
        $utmSource.value.trim(),
        $utmMedium.value.trim(),
        $utmContent.value.trim()
      );
      $out.textContent = url || "Generated link will appear here.";
      $status.textContent = url ? "ready" : "idle";
    }

    $genBtn.addEventListener("click", live);
    $copyBtn.addEventListener("click", async () => {
      const text = $out.textContent.trim();
      if (!text || text.startsWith("Generated link")) return;
      try {
        await navigator.clipboard.writeText(text);
        $status.textContent = "copied";
        setTimeout(()=>{$status.textContent="ready"}, 900);
      } catch(e) {
        const t = document.createElement("textarea");
        t.value = text; document.body.appendChild(t);
        t.select(); document.execCommand("copy"); document.body.removeChild(t);
        $status.textContent = "copied";
        setTimeout(()=>{$status.textContent="ready"}, 900);
      }
    });
  })();

  /* ===== Generator B: Redirect via n8n ===== */
  (function(){
    function toAsciiSlug(s) {
      return (s || "")
        .toString()
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^A-Za-z0-9\s\-_.]/g, " ")
        .replace(/[\s_]+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "")
        .toLowerCase()
        .slice(0, 80) || "ref";
    }
    const enc = (s)=>encodeURIComponent(s || "");

    function buildUrl(base, ref, useUtm, utmSource, utmMedium, utmContent) {
      if (!base) return "";
      const hasQ = base.includes("?");
      const join = hasQ ? "&" : "?";
      const q = [`ref=${enc(ref)}`];
      if (useUtm) {
        if (utmSource) q.push(`utm_source=${enc(utmSource)}`);
        if (utmMedium) q.push(`utm_medium=${enc(utmMedium)}`);
        q.push(`utm_content=${enc(utmContent || ref)}`);
      }
      return base + join + q.join("&");
    }

    const $base = document.getElementById("genB-base");
    const $saveBase = document.getElementById("genB-saveBase");
    const $keyword = document.getElementById("genB-keyword");
    const $customRef = document.getElementById("genB-customRef");
    const $useUtm = document.getElementById("genB-useUtm");
    const $asciiRef = document.getElementById("genB-asciiRef");
    const $utmSource = document.getElementById("genB-utmSource");
    const $utmMedium = document.getElementById("genB-utmMedium");
    const $utmContent = document.getElementById("genB-utmContent");
    const $genBtn = document.getElementById("genB-generate");
    const $copyBtn = document.getElementById("genB-copy");
    const $out = document.getElementById("genB-output");
    const $status = document.getElementById("genB-status");

    (function init(){
      const savedBase = localStorage.getItem("redirector_base_link");
      if (savedBase) $base.value = savedBase;
      if (!$utmSource.value) $utmSource.value = "blog";
      if (!$utmMedium.value) $utmMedium.value = "referral";
      const onChange = ()=>live();
      [$keyword,$customRef,$useUtm,$asciiRef,$utmSource,$utmMedium,$utmContent].forEach(el=>{
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', onChange);
      });
      live();
    })();

    $saveBase.addEventListener("click", () => {
      const v = ($base.value || "").trim();
      if (!/^https?:\/\//i.test(v)) { alert("Enter a valid URL"); return; }
      localStorage.setItem("redirector_base_link", v);
      $status.textContent = "base saved";
      setTimeout(()=>{$status.textContent="idle"}, 900);
      live();
    });

    function currentRef() {
      const raw = ($customRef.value || $keyword.value || "").trim();
      if (!raw) return "";
      if ($asciiRef.checked) return toAsciiSlug(raw);
      return raw;
    }

    function live() {
      const base = ($base.value || "").trim();
      const ref = currentRef();
      const url = buildUrl(
        base,
        ref,
        $useUtm.checked,
        $utmSource.value.trim(),
        $utmMedium.value.trim(),
        $utmContent.value.trim()
      );
      $out.textContent = url || "Generated link will appear here.";
      $status.textContent = url ? "ready" : "idle";
    }

    $genBtn.addEventListener("click", live);
    $copyBtn.addEventListener("click", async () => {
      const text = $out.textContent.trim();
      if (!text || text.startsWith("Generated link")) return;
      try {
        await navigator.clipboard.writeText(text);
        $status.textContent = "copied";
        setTimeout(()=>{$status.textContent="ready"}, 900);
      } catch(e) {
        const t = document.createElement("textarea");
        t.value = text; document.body.appendChild(t);
        t.select(); document.execCommand("copy"); document.body.removeChild(t);
        $status.textContent = "copied";
        setTimeout(()=>{$status.textContent="ready"}, 900);
      }
    });
  })();
</script>
</body>
</html>
