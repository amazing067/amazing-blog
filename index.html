<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>어메이징사업부 블로그 자동화</title>
  <style>
    :root{
      --bg1:#f8fbff; --bg2:#fff7fd; --ink:#111827; --ring:#9b87f5;
      --accent:#7c3aed; --accent2:#9b87f5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 12% -8%, var(--bg2), transparent 60%),
        radial-gradient(900px 600px at 108% 8%, #eaf2ff, transparent 55%),
        linear-gradient(180deg, var(--bg1), #fff);
      display:grid;place-items:center;padding:28px;
    }
    .wrap{width:100%;max-width:760px}
    .hero{ text-align:center; margin-bottom:14px; }
    .sticker{
      width:74px;height:74px;margin:0 auto 10px; border-radius:18px;display:grid;place-items:center;overflow:hidden;
      background:linear-gradient(135deg,#fef3c7,#fde68a);border:1px solid #fcd34d;
      box-shadow:inset 0 0 0 3px #ffffffb8,0 10px 26px #f59e0b33;
    }
    .title{
      font-size:28px; font-weight:900; margin:0;
      background:linear-gradient(90deg,#7c3aed,#22d3ee,#7c3aed);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      background-size:200% 100%; animation:shine 4s linear infinite;
      letter-spacing:-0.3px;
    }
    @keyframes shine{0%{background-position:0% 50%}100%{background-position:200% 50%}}
    .card{
      background:#ffffffcc;border:1px solid #eef2ff;border-radius:22px;backdrop-filter:blur(8px);
      box-shadow:0 12px 34px #00000012;padding:20px 18px 16px;
    }
    .ask{
      display:flex;align-items:center;gap:8px;background:#fff;border:1.5px solid #e5e7eb;
      border-radius:999px;padding:10px 10px 10px 14px; box-shadow:0 2px 8px #00000008;
      transition:box-shadow .2s,border .2s;
    }
    .ask input{
      flex:1;border:0;outline:none;font-size:15px;background:transparent;
      padding:6px 2px; min-height:22px;
    }
    .send{
      border:0;cursor:pointer; padding:10px 14px;border-radius:999px;color:#fff;
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      box-shadow:0 8px 18px #7c3aed33, inset 0 -6px 12px #00000014;
      display:inline-flex;align-items:center;gap:8px;font-weight:700;
      transition:transform .06s, filter .15s;
    }
    .send:hover{filter:brightness(1.04)}
    .send:active{transform:translateY(1px)}
    .send[disabled]{opacity:.65;cursor:not-allowed}
    .spin{width:16px;height:16px;border-radius:50%;border:2px solid #ffffff80;border-top-color:#fff;display:inline-block;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .helpers{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center}
    .helper{ font-size:12px;border:1px dashed #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer; }

    .res{
      margin-top:14px;background:#fff;border:1px solid #eef2ff;border-radius:16px;padding:14px;min-height:130px;
      white-space:pre-wrap;line-height:1.6
    }
    .placeholder{color:#9ca3af;font-size:14px}
    .status{
      display:flex;align-items:center;gap:10px;font-weight:800;
      background:linear-gradient(90deg,#7c3aed,#22d3ee,#7c3aed);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      background-size:200% 100%;animation:shine 3s linear infinite;
    }
    .test-indicator{position:fixed;top:10px;right:10px;background:#ff6b35;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;z-index:1000;}
    .res.editing{ outline:2px dashed #9b87f5; box-shadow: inset 0 0 0 3px #f3f0ff; }

    /* helpers / exporters 분리선 & 컬러 버튼 3종 */
    #exporters{
      border-top:1px dashed #e5e7eb;
      margin-top:12px; padding-top:12px; position:relative;
    }
    #exporters::before{
      content:""; position:absolute;left:0;right:0;top:-1px;height:1px;
      background:linear-gradient(90deg,#ffffff00,#e5e7eb,#ffffff00);
    }
    .chip{
      border:0; cursor:pointer; padding:8px 12px; border-radius:999px;
      color:#fff; font-weight:700; display:inline-flex; align-items:center; gap:6px;
      box-shadow:0 8px 18px #00000014, inset 0 -6px 12px #0000000f;
      transition:transform .06s, filter .15s;
    }
    .chip:hover{ filter:brightness(1.06); }
    .chip:active{ transform:translateY(1px); }
    .chip:disabled{ opacity:.55; cursor:not-allowed; }
    .chip-edit{ background:linear-gradient(135deg,#8b5cf6,#6d28d9); }
    .chip-html{ background:linear-gradient(135deg,#14b8a6,#0ea5e9); }
    .chip-pdf { background:linear-gradient(135deg,#f43f5e,#fb7185); }

    /* 카테고리 라벨 + 탭 (가운데 정렬) */
    #catHeader{ display:flex; align-items:center; justify-content:center; gap:8px; margin-top:12px; }
    #catBadge{
      font-size:11px; font-weight:900; letter-spacing:.6px;
      padding:4px 8px; border-radius:999px; color:#4c1d95; background:#ede9fe; border:1px solid #ddd6fe;
    }
    #tabs{ margin-top:6px; gap:6px; justify-content:center; }
    .tab{
      border:1px solid #e5e7eb; background:#fff; color:#374151;
      padding:8px 12px; border-radius:999px; font-size:12px; cursor:pointer;
      transition:background .15s, color .15s, border .15s;
    }
    .tab:hover{ background:#fafafa; }
    .tab.active{
      color:#fff; border:1px solid transparent;
      background:linear-gradient(135deg,#7c3aed,#22d3ee);
      box-shadow:0 8px 18px #7c3aed33, inset 0 -6px 12px #00000014;
    }

    /* 서식 툴바 */
    #toolbar{
      margin-top:12px; padding:10px; border:1px dashed #e5e7eb; border-radius:12px;
      background:linear-gradient(180deg,#ffffff,#fafbff);
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center;
    }
    .tool{
      border:0; cursor:pointer; border-radius:10px; padding:8px 10px; font-size:12px; font-weight:700;
      color:#fff; display:inline-flex; align-items:center; gap:6px;
      box-shadow:0 6px 14px #00000010, inset 0 -6px 12px #0000000f;
      transition:transform .06s, filter .15s;
    }
    .tool:hover{ filter:brightness(1.06); }
    .tool:active{ transform:translateY(1px); }
    .tool[disabled]{ opacity:.55; cursor:not-allowed; }
    .t-bold{ background:linear-gradient(135deg,#111827,#4b5563); }
    .t-italic{ background:linear-gradient(135deg,#6b7280,#9ca3af); }
    .t-underline{ background:linear-gradient(135deg,#0ea5e9,#38bdf8); }
    .t-h2{ background:linear-gradient(135deg,#16a34a,#22c55e); }
    .t-h3{ background:linear-gradient(135deg,#10b981,#34d399); }
    .t-ul{ background:linear-gradient(135deg,#fb923c,#f59e0b); }
    .t-ol{ background:linear-gradient(135deg,#f97316,#ea580c); }
    .t-left{ background:linear-gradient(135deg,#818cf8,#6366f1); }
    .t-center{ background:linear-gradient(135deg,#a78bfa,#8b5cf6); }
    .t-right{ background:linear-gradient(135deg,#c4b5fd,#a78bfa); }
    .t-link{ background:linear-gradient(135deg,#6366f1,#8b5cf6); }
    .t-color{ background:linear-gradient(135deg,#ef4444,#eab308,#22c55e,#3b82f6,#8b5cf6); color:#111827; font-weight:800; }
    .tool-lite{
      border:1px dashed #e5e7eb; background:#fff; color:#374151; box-shadow:none;
    }
    .color-picker{ appearance:none; width:28px; height:28px; border-radius:8px; border:1px solid #e5e7eb; padding:0; }
    .color-picker::-webkit-color-swatch{ border:none; border-radius:8px; }

    /* 이미지 리사이즈 핸들 & 떠있는 패널 */
    .img-selected{ outline:2px solid #7c3aed; outline-offset:2px; }
    .img-handle{
      position:absolute; width:12px; height:12px; border-radius:50%;
      background:#7c3aed; box-shadow:0 2px 6px #00000033; cursor:nwse-resize;
      right:-6px; bottom:-6px; z-index:2;
    }
    .img-fab{
      position:absolute; transform:translate(-50%,-100%); left:50%; top:0;
      background:#111827; color:#fff; padding:8px 10px; border-radius:12px;
      box-shadow:0 10px 24px #00000033; display:flex; align-items:center; gap:8px; z-index:2;
    }
    .img-fab input[type="range"]{ width:120px; }
    .img-fab button{ border:0; border-radius:999px; padding:6px 8px; cursor:pointer; font-weight:800; }
    .img-fab .p50{ background:#fde68a; }
    .img-fab .p75{ background:#a7f3d0; }
    .img-fab .p100{ background:#bfdbfe; }

    /* 스냅샷 박스 */
    #snapBox{
      margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center;
    }
    #snapBox select{ padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; }
    #snapBox .btn{ padding:8px 12px; border-radius:999px; border:0; color:#fff; font-weight:700; cursor:pointer; }
    #btnSnapSave{ background:linear-gradient(135deg,#0ea5e9,#6366f1); }
    #btnSnapLoad{ background:linear-gradient(135deg,#22c55e,#16a34a); }
    #btnSnapDel{  background:linear-gradient(135deg,#ef4444,#f97316); }

    /* 본문 전체 글자 크기 컨트롤 */
    #fontBox{ margin-top:8px; display:flex; justify-content:center; align-items:center; gap:8px; }
    #fontBox .btn{ padding:6px 10px; border-radius:8px; border:1px dashed #e5e7eb; background:#fff; cursor:pointer; }
    #fontBox .val{ font-weight:800; color:#334155; min-width:50px; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="sticker" aria-hidden="true">
        <svg viewBox="0 0 80 80" width="58" height="58">
          <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#fef3c7"/><stop offset="1" stop-color="#fde68a"/></linearGradient></defs>
          <circle cx="40" cy="40" r="28" fill="url(#g)" stroke="#fbbf24" stroke-width="2"/>
          <circle cx="32" cy="35" r="4" fill="#1f2937"/><circle cx="48" cy="35" r="4" fill="#1f2937"/>
          <path d="M28 49 Q40 58 52 49" stroke="#1f2937" stroke-width="3" fill="none" stroke-linecap="round"/>
          <path d="M18 26 26 18 M54 18 62 26" stroke="#f59e0b" stroke-width="3" stroke-linecap="round"/>
        </svg>
      </div>
      <h1 class="title">어메이징사업부 블로그 자동화</h1>
    </div>

    <!-- 카카오 링크 생성기 (원본 유지) -->
    <div class="card" id="chat-link-maker">
      <label style="display:block;font-size:14px;font-weight:800;margin-bottom:10px">카카오톡 블로그 채널링크 🔗</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="k-key" type="text" placeholder=""
               style="flex:1;padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;outline:none"/>
        <button id="k-make" class="send" type="button">생성 ✨</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
        <div id="k-result" class="placeholder" style="flex:1;word-break:break-all">결과 링크가 여기에 표시됩니다</div>
        <button id="k-copy" class="send" type="button" style="white-space:nowrap">복사 📋</button>
      </div>
    </div>

    <div class="card">
      <div class="ask">
        <input id="q" autocomplete="off" placeholder="주제를 입력하세요" />
        <button id="send" class="send" type="button"><span id="sendLabel">Send</span> 🚀</button>
      </div>

      <!-- 카테고리 라벨 + 탭 -->
      <div id="catHeader"><span id="catBadge">카테고리</span></div>
      <div class="helpers" id="tabs"></div>

      <!-- helpers (3개 로테이션) -->
      <div class="helpers" id="helpers"></div>

      <!-- 분리선 + 컬러 버튼 3종 -->
      <div class="helpers" id="exporters">
        <button class="chip chip-edit" id="toggleEdit" data-on="수정 종료" data-off="수정 모드">수정 모드</button>
        <button class="chip chip-html" id="downloadHtml" disabled>HTML 저장</button>
        <button class="chip chip-pdf"  id="downloadPdf"  disabled>PDF 저장</button>
      </div>

      <!-- 서식 툴바 -->
      <div id="toolbar" class="helpers">
        <button class="tool t-bold"      data-cmd="bold">굵게</button>
        <button class="tool t-italic"    data-cmd="italic">기울임</button>
        <button class="tool t-underline" data-cmd="underline">밑줄</button>
        <button class="tool t-h2"        data-cmd="formatBlock" data-val="H2">H2</button>
        <button class="tool t-h3"        data-cmd="formatBlock" data-val="H3">H3</button>
        <button class="tool t-ul"        data-cmd="insertUnorderedList">목록</button>
        <button class="tool t-ol"        data-cmd="insertOrderedList">번호</button>
        <button class="tool t-left"      data-cmd="justifyLeft">왼쪽</button>
        <button class="tool t-center"    data-cmd="justifyCenter">가운데</button>
        <button class="tool t-right"     data-cmd="justifyRight">오른쪽</button>
        <button class="tool t-link"      id="mkLink">링크</button>
        <label class="tool t-color" style="gap:8px;">
          색상 <input type="color" id="foreColor" class="color-picker" value="#333333" title="텍스트 색상"/>
        </label>
      </div>

      <!-- 스냅샷 + 전체 글씨크기 -->
      <div id="snapBox" class="helpers">
        <button class="btn" id="btnSnapSave">스냅샷 저장</button>
        <select id="snapSelect" title="저장된 스냅샷"></select>
        <button class="btn" id="btnSnapLoad">불러오기</button>
        <button class="btn" id="btnSnapDel">삭제</button>
      </div>
      <div id="fontBox" class="helpers">
        <button class="btn" id="fontDown">A-</button>
        <span class="val" id="fontVal">100%</span>
        <button class="btn" id="fontUp">A+</button>
        <span class="placeholder">/ 선택 글자크기: </span>
        <input type="range" id="selFont" min="70" max="200" value="100" style="width:140px" title="선택 영역 글자 크기"/>
      </div>

      <div id="res" class="res"><div class="placeholder">결과는 여기에 표시됩니다</div></div>
    </div>
  </div>

  <!-- 카테고리별 주제 30개씩 (샘플) -->
  <script type="application/json" id="topic-categories">{
    "실손보험": [
      "실손보험 청구서류 체크리스트 2025","실손보험 청구 방법 앱·병원서류 정리","실손보험 통원비 영수증 누락 대처",
      "비급여 주사 실손 청구 기준","도수치료·체외충격파 청구 가능 범위","MRI·MRA 실손 청구 되는지",
      "초음파·내시경 실손 인정 기준","치과 스케일링 실손 적용되는가","한의원 치료 실손 청구 포인트",
      "약제비 실손 청구 방법","전자영수증·처방전 분실 시 방법","실손 공제금액·자기부담 계산",
      "실손 합산한도와 중복가입 주의","스마트청구 앱 사용법 비교","실손 청구기한과 심사기간",
      "부지급 빈번한 사유 정리","입원의료비·통원의료비 차이","의무기록사본·진단서 발급 꿀팁",
      "비급여 주사 종류별 코드 정리","재가입/전환 시 유의사항","표준화 실손 vs 신실손 차이",
      "갱신 주기와 보험료 인상 포인트","특약 구성 최소·권장 가이드","치료 후 영수증 분실 해결",
      "질병/상해 구분 체크리스트","치료비 선결제 후 청구 절차","실손 보상비율 계산 예시",
      "간병비·도우미 비용 청구 가능?","해외 진료 실손 청구 되는지","이중 청구 방지 체크포인트"
    ],
    "암보험": [
      "암보험 진단비 지급조건 핵심","유사암 보장 범위와 예외","갑상선암 소액암 기준 업데이트",
      "기타피부암 코드와 청구 포인트","표적항암·면역항암 보장 구조","항암 방사선·수술 병행 보장",
      "암 산정특례 신청 방법","암 입원일당·수술비 구성법","재진단암 보장 조건 비교",
      "항암 부작용 보장(오심·탈모 등)","암보험 갱신형 vs 비갱신형","무해지환급형 장단점",
      "여성암 특약(유방·자궁) 비교","남성암 특약(전립선 등) 체크","가족력 있을 때 가입 팁",
      "가입 전 고지사항 체크리스트","보험금 부지급 자주 나오는 사례","암진단 코드 C~ 구분 이해",
      "표적치료제 본인부담 비용 사례","면역항암 급여/비급여 차이","암 치료비 절감 팁 모음",
      "보험료 인상 요인과 관리법","다른 특약과 중복 보장 사례","치료 후 추가검사 비용 보장",
      "유사암에서 일반암 전환 사례","치료 중 이사/병원 변경 청구","암 완치 후 보험 재가입",
      "어린이 암보험 고려 포인트","고령자 암보험 가능 여부","암보험 약관 읽는 법"
    ],
    "운전자보험": [
      "운전자보험 특약 최소 구성 가이드","형사합의금·변호사비용 보장","교통사고처리지원금 지급조건",
      "벌점·면허정지·취소 관련 보장","음주·무면허 예외 조항 정리","스쿨존 사고 보장 범위",
      "자전거·킥보드 사고 보장 확인","대물·대인과의 차이 이해","초과책임 보장 체크",
      "과실비율에 따른 처리 팁","뺑소니 가해·피해 보장 차이","합의 요령 및 서류",
      "특약별 가입금액 권장선","자기부담금 구조 이해","가족운전자 범위 설정",
      "자동차상해 vs 자동차보험 차이","택시·대리운전 종사자 특약","운전자보험 갱신/해지 팁",
      "벌금 보장 한도와 제외","중상해처벌법 관련 이슈","대리기사 사고 시 처리",
      "주정차 사고 처리 요령","차대사람 사고 합의 팁","렌트카·카셰어링 보장여부",
      "무단횡단 사고 대응","블랙박스 영상 보존 요령","사고 후 병원 진단서 준비",
      "초보운전 꼭 알아둘 특약","신차 구매 전 체크리스트","보험료 아끼는 팁"
    ],
    "장기요양/간병": [
      "장기요양 등급 판정 기준 총정리","장기요양 인정점수 계산 방법","등급별 이용 가능 서비스",
      "방문요양·목욕·간호 차이","시설 입소 절차와 비용","가족요양 조건과 주의사항",
      "본인부담금 계산과 감면","간병인 비용 현실과 보장","간병인보험 핵심 특약",
      "요양병원 vs 요양원 차이","치매 등급과 지원 제도","장기요양 재판정 준비",
      "돌봄서비스 지역 지원 찾기","환자이송 서비스 비용","의사 소견서 준비 요령",
      "수급자·보호자 체크리스트","지급정지/변경 사유 정리","요양서비스 불만 처리",
      "재활치료 병행 시 비용","간병 소모품 지원 안내","등급탈락 후 대처법",
      "가정간호보험 활용법","장기요양보험료 산정","요양 도중 이사 대응",
      "대상자 부재 시 처리","국민건강보험 공단 절차","장기요양 공단 전화 꿀팁",
      "방문요양 기관 선택 기준","야간/24시간 간병 비용","가사·돌봄 바우처 안내"
    ],
    "해외여행보험": [
      "해외여행보험 보장 범위 한눈에","해외 치료비 청구 절차","항공기 지연·결항 보장",
      "수하물 분실·파손 보장","여권 분실 긴급조치","코로나 관련 보장 여부",
      "임신 중 여행 보장 유의사항","레저·스포츠 특약 필요성","해외 병원 영문서류 준비",
      "현지 병원 찾는 법·연락처","자기부담금·한도 설정","동반가족 보장 범위",
      "장기 여행자보험 선택 팁","워홀·유학 보험 체크","해외에서 약국 이용 팁",
      "영문진단서 발급 방법","귀국 후 청구 서류 정리","현지 통화 결제/환불",
      "해외 렌트카 사고 처리","여행 중 도난 신고 절차","질병 악화 면책 조항",
      "만성질환 복용약 준비","휴대품 한도·예외 규정","여행 취소비용 보장",
      "고지의무 위반 주의","해외 산행·스쿠버 보장","모바일 청구 방법",
      "장거리 경유 지연 팁","비자/입국 제한 체크","해외 의료비 견적 비교"
    ],
    "뇌·심혈관": [
      "뇌졸중 vs 뇌출혈 차이","허혈성심장질환·심근경색 차이","협심증 보장 가능 범위",
      "스텐트 시술 보장 체크","심전도·Troponin 기준 이해","MRI/MRA 급여·비급여",
      "응급실 내원 기록 중요성","후유장해 보장과 평가","재활치료 비용과 청구",
      "고혈압·고지혈증 고지사항","심장재활 프로그램 안내","뇌 MRI 코드 정리",
      "CT/MRI 선택 가이드","뇌혈관 진단금 지급요건","심근경색 진단금 예시",
      "뇌졸중 후유증 관리 팁","뇌혈관 수술비 보장","심장 스텐트 갱신 이슈",
      "병상일당·수술일당 조합","중환자실 보장 여부","구급차 이송비 청구",
      "약물치료·재발 리스크","퇴원 후 통원치료 청구","건강검진 이상소견 대응",
      "운전 가능 시점·서류","장기복용 약 관리","생활습관 관리 체크",
      "산재/교통사고와 중복 여부","질병코드 I21·I63 이해","보험료 절감 팁"
    ]
  }</script>

<script>
  // ========== 공통 ==========
  function isTestMode(){ return location.search.includes('test=true') || location.search.includes('debug=true'); }
  const HOOKS_BASE='https://hooks.xn--h32b21du9cf7grcy2k20f.com';
  const WF_PATH='ask';
  const WEBHOOK_URL = isTestMode()?`${HOOKS_BASE}/webhook-test/${WF_PATH}`:`${HOOKS_BASE}/webhook/${WF_PATH}`;
  if (isTestMode()){
    const indicator=document.createElement('div'); indicator.className='test-indicator'; indicator.textContent='TEST MODE';
    document.body.appendChild(indicator);
  }

  const $=(s)=>document.querySelector(s);
  const q=$('#q'), btn=$('#send'), res=$('#res'), sendLabel=$('#sendLabel');

  function loading(on){
    if(on){ btn.disabled=true; sendLabel.innerHTML='<span class="spin"></span>'; res.innerHTML='<div class="status"><span class="spin"></span>AI is working…</div>'; }
    else { btn.disabled=false; sendLabel.textContent='Send'; }
  }

  async function postJson(url, body, timeoutMs=30000){
    const controller=new AbortController(); const t=setTimeout(()=>controller.abort(), timeoutMs);
    try{
      const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),signal:controller.signal});
      const text=await r.text(); let data; try{data=JSON.parse(text);}catch{data={raw:text};}
      return {ok:r.ok,status:r.status,data};
    } finally { clearTimeout(t); }
  }

  function looksLikeHtml(s){ return /^\s*<(?:!DOCTYPE|html|body|main|div|section|article|h1|h2|p|iframe)\b/i.test(s||""); }
  function decodeHtmlEntities(str){ if(typeof str!=='string') return str; const el=document.createElement('textarea'); el.innerHTML=str; return el.value; }
  function extractEmbeddable(htmlString){
    try{
      const s=String(htmlString||"");
      const m=s.match(/^\s*<iframe\b[^>]*\bsrcdoc=(["'])([\s\S]*?)\1[^>]*>\s*<\/iframe>\s*$/i);
      if(m){ const ta=document.createElement('textarea'); ta.innerHTML=m[2]; return ta.value; }
      if(/^\s*<iframe\b/i.test(s)) return s;
      const parser=new DOMParser(); const doc=parser.parseFromString(s,'text/html');
      const main=doc.querySelector('main'); if(main) return main.innerHTML;
      if(doc.body) return doc.body.innerHTML || s;
      return s;
    }catch{ return htmlString; }
  }
  function pickHtmlPayload(data, fallback){
    const candidates=[data?.html_document,data?.html,data?.content,data?.body,data?.answer?.html_document,data?.answer?.html,data?.data?.html_document,data?.data?.html,data?.json?.html_document,data?.json?.html,fallback].filter(v=>typeof v==='string');
    for(let raw of candidates){ const dec=/&lt;|&gt;|&amp;|&quot;|&#39;/.test(raw)?decodeHtmlEntities(raw):raw; if(looksLikeHtml(dec)) return dec; }
    return null;
  }

  // ===== 수정 모드 & 내보내기 =====
  let editMode=false;
  const dlHtmlBtn=$('#downloadHtml'), dlPdfBtn=$('#downloadPdf'), toggleBtn=$('#toggleEdit'), toolbar=$('#toolbar');

  function enableExports(on){ if(dlHtmlBtn) dlHtmlBtn.disabled=!on; if(dlPdfBtn) dlPdfBtn.disabled=!on; }
  function currentResultHTML(){
    const inner=res.innerHTML||'';
    return '<!DOCTYPE html><html lang="ko"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>result</title></head><body>'+inner+'</body></html>';
  }
  function downloadHTMLFile(){
    const blob=new Blob([currentResultHTML()],{type:'text/html;charset=utf-8'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='result.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function downloadPDFFile(){
    const w=window.open('','_blank'); if(!w){ alert('팝업을 허용해주세요.'); return; }
    w.document.open(); w.document.write(currentResultHTML()); w.document.close(); w.focus(); setTimeout(()=>w.print(),150);
  }
  function toggleEditMode(){
    editMode=!editMode;
    res.contentEditable=editMode?"true":"false";
    res.classList.toggle('editing',!!editMode);
    const onLabel=toggleBtn.getAttribute('data-on')||'수정 종료';
    const offLabel=toggleBtn.getAttribute('data-off')||'수정 모드';
    toggleBtn.textContent=editMode?onLabel:offLabel;
    [...toolbar.querySelectorAll('.tool,.color-picker')].forEach(el=>el.disabled=!editMode);
  }
  if(dlHtmlBtn) dlHtmlBtn.addEventListener('click', downloadHTMLFile);
  if(dlPdfBtn) dlPdfBtn.addEventListener('click', downloadPDFFile);
  if(toggleBtn) toggleBtn.addEventListener('click', toggleEditMode);
  [...toolbar.querySelectorAll('.tool,.color-picker')].forEach(el=>el.disabled=true);

  // ===== 전송 =====
  async function send(){
    const topic=q.value.trim(); if(topic.length<2){ q.focus(); res.textContent='Please enter at least 2 characters.'; return; }
    loading(true);
    try{
      const r=await postJson(WEBHOOK_URL,{topic});
      if(!r.ok){ res.textContent=`HTTP ${r.status}\n`+JSON.stringify(r.data,null,2); enableExports(false); return; }
      const ans=r.data?.answer ?? r.data?.data ?? r.data?.raw ?? r.data ?? {ok:true};
      const html=pickHtmlPayload(r.data, typeof ans==='string'?ans:'');
      if(html){
        const cleaned=decodeHtmlEntities(html); const emb=extractEmbeddable(cleaned);
        res.innerHTML=emb; res.style.whiteSpace='normal'; res.style.textAlign='left'; res.style.display='block'; res.style.minHeight='auto';
        res.contentEditable=editMode?"true":"false"; res.classList.toggle('editing',!!editMode);
        enableExports(true); attachResizeToImages(); scheduleIdleSave(); // 결과 갱신 시 저장 예약
        return;
      }
      res.textContent=(typeof ans==='string')?ans:JSON.stringify(ans,null,2);
      enableExports(true); scheduleIdleSave();
    }catch(e){
      res.textContent='Network error: '+(e?.message||String(e));
      enableExports(false);
    }finally{ loading(false); }
  }
  btn.addEventListener('click', send);
  q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

  // ===== 카테고리 탭 + 3개 로테이션 =====
  const tabsEl=$('#tabs'), helpersEl=$('#helpers'); const ROTATE_MS=12000;
  let categories={}, catNames=[], currentCat=null, order=[], cursor=0, rotateTimer=null;

  function loadCategories(){ try{ const raw=$('#topic-categories')?.textContent||'{}'; const obj=JSON.parse(raw); return obj&&typeof obj==='object'?obj:{}; }catch{ return {}; } }
  function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]; } return x; }
  function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function escAttr(s){ return escHtml(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  function renderTabs(){
    tabsEl.innerHTML=catNames.map((c,i)=>`<button class="tab ${i===0?'active':''}" data-cat="${escAttr(c)}">${escHtml(c)}</button>`).join('');
    currentCat=catNames[0]||null; resetRotation();
  }
  function resetRotation(){
    const pool=(categories[currentCat]||[]); order=shuffle(pool.map((_,i)=>i)); cursor=0; renderHelpers();
    if(rotateTimer) clearInterval(rotateTimer); rotateTimer=setInterval(renderHelpers, ROTATE_MS);
  }
  function nextSet(n=3){
    const pool=(categories[currentCat]||[]); if(pool.length===0) return [];
    if(cursor>=order.length){ order=shuffle(order); cursor=0; }
    const idxs=order.slice(cursor, cursor+n); cursor+=n; return idxs.map(i=>pool[i]);
  }
  function renderHelpers(){ const items=nextSet(3); helpersEl.innerHTML=items.map(t=>`<button class="helper" data-text="${escAttr(t)}">${escHtml(t)}</button>`).join(''); }
  tabsEl.addEventListener('click',(e)=>{ const tab=e.target.closest('.tab'); if(!tab) return; tabsEl.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); tab.classList.add('active'); currentCat=tab.getAttribute('data-cat'); resetRotation(); });
  if(helpersEl){ helpersEl.addEventListener('click',(e)=>{ const b=e.target.closest('.helper'); if(!b) return; q.value=b.getAttribute('data-text')||b.textContent||''; }); }

  // ===== 서식 툴바 =====
  function applyCmd(cmd,val=null){ if(!editMode) toggleEditMode(); document.execCommand(cmd,false,val); res.focus(); scheduleIdleSave(); }
  $('#toolbar').addEventListener('click',(e)=>{
    const b=e.target.closest('.tool'); if(!b) return;
    if(b.id==='mkLink'){ const url=prompt('링크 URL을 입력하세요'); if(url && /^https?:\/\//i.test(url)) applyCmd('createLink',url); return; }
    const cmd=b.getAttribute('data-cmd'); const val=b.getAttribute('data-val'); if(cmd) applyCmd(cmd,val);
  });
  $('#foreColor').addEventListener('input',(e)=>{ applyCmd('foreColor', e.target.value); });

  // ===== 전체 글씨 크기(A-/A+) & 선택 글자크기 슬라이더 =====
  let globalFont=100;
  function applyGlobalFont(){ res.style.fontSize=globalFont+'%'; $('#fontVal').textContent=globalFont+'%'; scheduleIdleSave(); }
  $('#fontDown').addEventListener('click',()=>{ globalFont=Math.max(70, globalFont-10); applyGlobalFont(); });
  $('#fontUp').addEventListener('click',()=>{ globalFont=Math.min(200, globalFont+10); applyGlobalFont(); });

  $('#selFont').addEventListener('input',(e)=>{
    const size=parseInt(e.target.value,10);
    if(!editMode) toggleEditMode();
    const sel=window.getSelection();
    if(!sel || sel.rangeCount===0) return;
    const range=sel.getRangeAt(0);
    const span=document.createElement('span'); span.style.fontSize=size+'%';
    range.surroundContents(span);
    sel.removeAllRanges(); const r=document.createRange(); r.selectNodeContents(span); sel.addRange(r);
    scheduleIdleSave();
  });

  // ===== 이미지 드래그&드롭/붙여넣기 + 리사이즈 =====
  function insertAtCaret(node){
    const sel=window.getSelection();
    if(sel && sel.rangeCount && res.contains(sel.anchorNode)){
      const range=sel.getRangeAt(0); range.deleteContents(); range.insertNode(node); range.collapse(false); sel.removeAllRanges(); sel.addRange(range);
    } else { res.appendChild(node); }
  }
  function handleFiles(files){
    if(!files || !files.length) return;
    if(!editMode) toggleEditMode();
    [...files].forEach(file=>{
      if(!file.type.startsWith('image/')) return;
      const reader=new FileReader();
      reader.onload=()=>{
        const img=new Image(); img.src=reader.result; img.style.maxWidth='100%'; img.style.height='auto'; img.style.display='block'; img.style.margin='8px 0';
        insertAtCaret(img); attachResizeToImage(img); scheduleIdleSave();
      };
      reader.readAsDataURL(file);
    });
  }
  res.addEventListener('dragover', (e)=>{ e.preventDefault(); res.classList.add('editing'); });
  res.addEventListener('dragleave', ()=>{ res.classList.toggle('editing', !!editMode); });
  res.addEventListener('drop', (e)=>{ e.preventDefault(); handleFiles(e.dataTransfer.files); res.classList.toggle('editing', !!editMode); });
  res.addEventListener('paste', (e)=>{
    const items=e.clipboardData && e.clipboardData.items; if(!items) return;
    const imgs=[]; for(const it of items){ if(it.type && it.type.indexOf('image/')===0) imgs.push(it.getAsFile()); }
    if(imgs.length){ e.preventDefault(); handleFiles(imgs); }
  });

  // 이미지 리사이즈: 클릭 시 핸들 + 패널
  let currentImg=null, handleEl=null, fabEl=null, startX=0, startW=0;
  function attachResizeToImages(){ res.querySelectorAll('img').forEach(attachResizeToImage); }
  function attachResizeToImage(img){
    img.style.cursor='pointer';
    img.addEventListener('click', (e)=>{ e.stopPropagation(); selectImage(img); });
  }
  function selectImage(img){
    if(currentImg===img){ showFab(img); return; }
    clearImageUI();
    currentImg=img; img.classList.add('img-selected'); showHandle(img); showFab(img);
  }
  function clearImageUI(){
    if(currentImg) currentImg.classList.remove('img-selected');
    if(handleEl){ handleEl.remove(); handleEl=null; }
    if(fabEl){ fabEl.remove(); fabEl=null; }
    currentImg=null;
  }
  document.addEventListener('click',(e)=>{ if(!res.contains(e.target)) clearImageUI(); });

  function showHandle(img){
    const rect=img.getBoundingClientRect();
    handleEl=document.createElement('div'); handleEl.className='img-handle';
    // 핸들은 이미지의 offsetParent 기준 위치가 필요 → wrapper 없이 position:relative 대체
    img.style.position='relative';
    img.parentElement.style.position='relative';
    img.parentElement.appendChild(handleEl);

    handleEl.addEventListener('mousedown',(e)=>{
      e.preventDefault();
      startX=e.clientX; startW=img.getBoundingClientRect().width;
      const onMove=(me)=>{
        const dx=me.clientX-startX;
        const newW=Math.max(50, startW+dx);
        const parentW=img.parentElement.getBoundingClientRect().width||newW;
        const pct=Math.round((newW/parentW)*100);
        img.style.width=pct+'%'; img.style.maxWidth='100%';
        updateFab(pct);
      };
      const onUp=()=>{ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); scheduleIdleSave(); };
      document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
    });
  }
  function showFab(img){
    if(fabEl) fabEl.remove();
    fabEl=document.createElement('div'); fabEl.className='img-fab';
    const parentW=img.parentElement.getBoundingClientRect().width||img.width;
    const curPct=Math.round((img.getBoundingClientRect().width/parentW)*100)||100;
    fabEl.innerHTML=`
      <input type="range" min="10" max="100" value="${Math.max(10, Math.min(100, curPct))}">
      <button class="p50">50%</button>
      <button class="p75">75%</button>
      <button class="p100">100%</button>
    `;
    // 위치: 이미지 상단 중앙
    img.parentElement.style.position='relative';
    img.parentElement.appendChild(fabEl);

    const range=fabEl.querySelector('input[type="range"]');
    range.addEventListener('input',(e)=>{ const v=parseInt(e.target.value,10); img.style.width=v+'%'; updateFab(v); });
    fabEl.querySelector('.p50').addEventListener('click',()=>{ img.style.width='50%'; updateFab(50); scheduleIdleSave(); });
    fabEl.querySelector('.p75').addEventListener('click',()=>{ img.style.width='75%'; updateFab(75); scheduleIdleSave(); });
    fabEl.querySelector('.p100').addEventListener('click',()=>{ img.style.width='100%'; updateFab(100); scheduleIdleSave(); });
  }
  function updateFab(pct){
    if(!fabEl) return;
    const range=fabEl.querySelector('input[type="range"]');
    if(range) range.value=Math.max(10,Math.min(100, pct));
  }

  // ===== 카카오 링크 생성기 (원본 유지) =====
  (function(){
    const BASE='https://hooks.xn--h32b21du9cf7grcy2k20f.com/webhook/kakao-redirect';
    const key=$('#k-key'); const btnMake=$('#k-make'); const btnCopy=$('#k-copy'); const out=$('#k-result');
    function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,10); }
    function build(){ const kw=(key.value||'').trim(); if(!kw){ out.textContent='키워드를 입력하세요'; out.classList.add('placeholder'); return; } const u=uid(); const qs=new URLSearchParams({ref:kw,utm_content:u}).toString(); const url=BASE+(BASE.includes('?')?'&':'?')+qs; out.innerHTML=`<a href="${url}" target="_blank" rel="noopener">${url}</a>`; out.classList.remove('placeholder'); }
    async function copy(){ const a=out.querySelector('a'); const url=a?a.href:(out.textContent||'').trim(); if(!/^https?:\/\//.test(url)){ out.textContent='먼저 링크를 생성하세요'; out.classList.add('placeholder'); return; } try{ await navigator.clipboard.writeText(url); btnCopy.textContent='복사 완료 ✅'; setTimeout(()=>btnCopy.textContent='복사 📋',1200);}catch{ const t=document.createElement('textarea'); t.value=url; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); btnCopy.textContent='복사 완료 ✅'; setTimeout(()=>btnCopy.textContent='복사 📋',1200);} }
    if(btnMake) btnMake.addEventListener('click', build);
    if(btnCopy) btnCopy.addEventListener('click', copy);
    if(key) key.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); build(); }});
  })();

  // ===== 자동 저장 (유휴 1분 + 주기 5분) & 복원 =====
  const DRAFT_KEY='blog_auto_draft_v1';
  let idleTimer=null, periodicTimer=null;

  function serializeDraft(){ return { v:3, ts:Date.now(), topic:(q?.value||'').trim(), html:res?.innerHTML||'', edit:!!editMode, globalFont }; }
  function saveDraft(){ try{ const data=serializeDraft(); localStorage.setItem(DRAFT_KEY, JSON.stringify(data)); /*console.log('saved', new Date(data.ts))*/ }catch(e){ console.warn('autosave failed',e); } }
  function scheduleIdleSave(){ if(idleTimer) clearTimeout(idleTimer); idleTimer=setTimeout(saveDraft, 60*1000); } // 1분 유휴
  function startPeriodicSave(){ if(periodicTimer) clearInterval(periodicTimer); periodicTimer=setInterval(saveDraft, 5*60*1000); } // 5분 주기
  function restoreDraft(){
    try{
      const raw=localStorage.getItem(DRAFT_KEY); if(!raw) return;
      const data=JSON.parse(raw); if(!data||typeof data!=='object') return;
      if(typeof data.topic==='string') q.value=data.topic;
      if(typeof data.html==='string'){ res.innerHTML=data.html; enableExports(true); attachResizeToImages(); }
      if(data.edit){ if(!editMode) toggleEditMode(); }
      if(data.globalFont){ globalFont=data.globalFont; res.style.fontSize=globalFont+'%'; $('#fontVal').textContent=globalFont+'%'; }
    }catch(e){ console.warn('restore failed', e); }
  }
  function bindAutoSaveEvents(){
    if(q) q.addEventListener('input', scheduleIdleSave);
    if(res) res.addEventListener('input', scheduleIdleSave);
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveDraft(); });
    window.addEventListener('beforeunload', saveDraft);
    startPeriodicSave();
  }

  // ===== 스냅샷(히스토리) =====
  const SNAP_KEY='blog_snapshots_v1'; const snapSelect=$('#snapSelect');
  function loadSnaps(){ try{ const raw=localStorage.getItem(SNAP_KEY); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]; }catch{return [];} }
  function saveSnaps(arr){ localStorage.setItem(SNAP_KEY, JSON.stringify(arr)); }
  function refreshSnapSelect(){
    const arr=loadSnaps();
    snapSelect.innerHTML=arr.map((s,i)=>`<option value="${i}">${new Date(s.ts).toLocaleString()} — ${s.topic?.slice(0,24)||'제목없음'}</option>`).join('');
  }
  function snapNow(){
    const arr=loadSnaps();
    const data=serializeDraft();
    arr.unshift(data);
    if(arr.length>10) arr.length=10; // 최대 10개 유지
    saveSnaps(arr); refreshSnapSelect();
  }
  function loadSnap(){
    const arr=loadSnaps(); const idx=parseInt(snapSelect.value||'0',10);
    const s=arr[idx]; if(!s) return;
    q.value=s.topic||''; res.innerHTML=s.html||''; enableExports(true); attachResizeToImages();
    if(!!s.edit && !editMode) toggleEditMode(); if(!s.edit && editMode) toggleEditMode();
    globalFont=s.globalFont||100; res.style.fontSize=globalFont+'%'; $('#fontVal').textContent=globalFont+'%';
    scheduleIdleSave();
  }
  function delSnap(){
    const arr=loadSnaps(); const idx=parseInt(snapSelect.value||'0',10);
    if(arr[idx]){ arr.splice(idx,1); saveSnaps(arr); refreshSnapSelect(); }
  }
  $('#btnSnapSave').addEventListener('click', snapNow);
  $('#btnSnapLoad').addEventListener('click', loadSnap);
  $('#btnSnapDel').addEventListener('click', delSnap);

  // ===== 부팅 =====
  function init(){
    // 카테고리
    categories=loadCategories(); catNames=Object.keys(categories);
    if(catNames.length){ renderTabs(); } else { $('#tabs').innerHTML=''; $('#helpers').innerHTML='<div class="placeholder">주제 풀이 없습니다</div>'; }
    // 복원 & 오토세이브
    restoreDraft(); bindAutoSaveEvents(); refreshSnapSelect();
    // 초기 이미지에 리사이즈 부착(있다면)
    attachResizeToImages();
  }
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
