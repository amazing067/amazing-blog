<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>어메이징사업부 블로그 자동화</title>
  <style>
    :root{ --bg1:#f8fbff; --bg2:#fff7fd; --ink:#111827; --ring:#9b87f5; --accent:#7c3aed; --accent2:#9b87f5; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 12% -8%, var(--bg2), transparent 60%),
        radial-gradient(900px 600px at 108% 8%, #eaf2ff, transparent 55%),
        linear-gradient(180deg, var(--bg1), #fff);
      display:grid;place-items:center;padding:28px;
    }
    .wrap{width:100%;max-width:760px}
    .hero{ text-align:center; margin-bottom:14px; }
    .sticker{
      width:74px;height:74px;margin:0 auto 10px; border-radius:18px;display:grid;place-items:center;overflow:hidden;
      background:linear-gradient(135deg,#fef3c7,#fde68a);border:1px solid #fcd34d;
      box-shadow:inset 0 0 0 3px #ffffffb8,0 10px 26px #f59e0b33;
    }
    .title{
      font-size:28px; font-weight:900; margin:0;
      background:linear-gradient(90deg,#7c3aed,#22d3ee,#7c3aed);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      background-size:200% 100%; animation:shine 4s linear infinite;
      letter-spacing:-0.3px;
    }
    @keyframes shine{0%{background-position:0% 50%}100%{background-position:200% 50%}}
    .card{
      background:#ffffffcc;border:1px solid #eef2ff;border-radius:22px;backdrop-filter:blur(8px);
      box-shadow:0 12px 34px #00000012;padding:20px 18px 16px;
    }
    .ask{
      display:flex;align-items:center;gap:8px;background:#fff;border:1.5px solid #e5e7eb;
      border-radius:999px;padding:10px 10px 10px 14px; box-shadow:0 2px 8px #00000008;
      transition:box-shadow .2s,border .2s;
    }
    .ask input{
      flex:1;border:0;outline:none;font-size:15px;background:transparent;
      padding:6px 2px; min-height:22px;
    }
    .send{
      border:0;cursor:pointer; padding:10px 14px;border-radius:999px;color:#fff;
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      box-shadow:0 8px 18px #7c3aed33, inset 0 -6px 12px #00000014;
      display:inline-flex;align-items:center;gap:8px;font-weight:700;
      transition:transform .06s, filter .15s;
    }
    .send:hover{filter:brightness(1.04)}
    .send:active{transform:translateY(1px)}
    .send[disabled]{opacity:.65;cursor:not-allowed}
    .spin{width:16px;height:16px;border-radius:50%;border:2px solid #ffffff80;border-top-color:#fff;display:inline-block;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .helpers{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center}
    .helper{ font-size:12px;border:1px dashed #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer; }
    .res{
      margin-top:14px;background:#fff;border:1px solid #eef2ff;border-radius:16px;padding:14px;min-height:130px;
      white-space:pre-wrap;line-height:1.6
    }
    .placeholder{color:#9ca3af;font-size:14px}
    .status{
      display:flex;align-items:center;gap:10px;font-weight:800;
      background:linear-gradient(90deg,#7c3aed,#22d3ee,#7c3aed);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      background-size:200% 100%;animation:shine 3s linear infinite;
    }
    .test-indicator{position:fixed;top:10px;right:10px;background:#ff6b35;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;z-index:1000;}
    /* edit mode marker */
    .res.editing{ outline:2px dashed #9b87f5; box-shadow: inset 0 0 0 3px #f3f0ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="sticker" aria-hidden="true">
        <svg viewBox="0 0 80 80" width="58" height="58">
          <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#fef3c7"/><stop offset="1" stop-color="#fde68a"/></linearGradient></defs>
        <circle cx="40" cy="40" r="28" fill="url(#g)" stroke="#fbbf24" stroke-width="2"/>
        <circle cx="32" cy="35" r="4" fill="#1f2937"/><circle cx="48" cy="35" r="4" fill="#1f2937"/>
        <path d="M28 49 Q40 58 52 49" stroke="#1f2937" stroke-width="3" fill="none" stroke-linecap="round"/>
        <path d="M18 26 26 18 M54 18 62 26" stroke="#f59e0b" stroke-width="3" stroke-linecap="round"/>
        </svg>
      </div>
      <h1 class="title">어메이징사업부 블로그 자동화</h1>
    </div>

    <!-- 카카오 채널 링크 생성기 -->
    <div class="card" id="chat-link-maker">
      <label style="display:block;font-size:14px;font-weight:800;margin-bottom:10px">
        카카오톡 블로그 채널링크 🔗
      </label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="k-key" type="text" placeholder=""
               style="flex:1;padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;outline:none"/>
        <button id="k-make" class="send" type="button">생성 ✨</button>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
        <div id="k-result" class="placeholder" style="flex:1;word-break:break-all">
          결과 링크가 여기에 표시됩니다
        </div>
        <button id="k-copy" class="send" type="button" style="white-space:nowrap">복사 📋</button>
      </div>
    </div>

    <div class="card">
      <div class="ask">
        <input id="q" autocomplete="off" placeholder="주제를 입력하세요" />
        <button id="send" class="send" type="button"><span id="sendLabel">Send</span> 🚀</button>
      </div>

      <!-- helpers: JS가 3개씩 랜더링함 -->
      <div class="helpers" id="helpers">
        <!-- JS will inject three buttons here -->
      </div>

      <!-- 결과 영역 컨트롤 -->
      <div class="helpers" id="exporters">
        <button class="helper" id="toggleEdit">수정 모드</button>
        <button class="helper" id="downloadHtml" disabled>HTML 저장</button>
        <button class="helper" id="downloadPdf" disabled>PDF 저장</button>
      </div>

      <div id="res" class="res"><div class="placeholder">결과는 여기에 표시됩니다</div></div>
    </div>
  </div>

  <!-- 검색 의도형 주제 리스트(JSON, JS 아님) -->
  <script type="application/json" id="topic-data">[
    "실손보험 청구서류 체크리스트 2025",
    "실손보험 청구 방법 병원서류부터 앱청구까지",
    "실손보험 통원비 영수증 누락 대처법",
    "암보험 진단비 지급조건 핵심정리",
    "유사암 보장 범위 기·갑·경·제 차이",
    "여성암 보험 유방암·자궁암 비교 2025",
    "질병수술비 보장 항목과 면책기간 이해",
    "골절보험 깁스·통원 보장 실제 사례",
    "운전자보험 특약 최소 구성 가이드",
    "운전자보험 면책·예외 조항 꼭 알아두기",
    "뇌혈관질환·허혈성심장질환 진단비 차이",
    "뇌 MRI·MRA 촬영 보험 청구 가능범위",
    "장기요양보험 등급 판정 기준과 준비서류",
    "간병인 비용 보장 실손 vs 정액 비교",
    "치매보험 경도·중등도·중증 지급기준",
    "대체의료 중입자·양성자 치료 보장 비교",
    "암 산정특례 신청 방법과 절차",
    "표적항암·면역항암 치료비 보장 구조",
    "갱신형 vs 비갱신형 보험 장단점 비교",
    "무해지형 보험 환급 구조 이해하기",
    "유병자 보험 3·2·5 조건과 인수 포인트",
    "건강검진 전 보험 가입 시 유의사항",
    "운전자보험 최저 구성과 벌점·면허정지 특약",
    "어린이보험 태아·출생 직후 보장 체크",
    "산업재해보험 산재 승인 절차 7단계",
    "해외여행자보험 의료·항공지연 보장 범위",
    "골절·화상 수술비 중복 보장 가능할까",
    "기타피부암 코드 기준과 청구 포인트",
    "갑상선암 소액암 기준과 예외 사례",
    "보험금 부지급 빈번한 사유 TOP7"
  ]</script>

<script>
  // test mode
  function isTestMode() {
    return window.location.search.includes('test=true') || window.location.search.includes('debug=true');
  }
  const HOOKS_BASE = 'https://hooks.xn--h32b21du9cf7grcy2k20f.com';
  const WF_PATH = 'ask';
  const WEBHOOK_URL = isTestMode()
    ? `${HOOKS_BASE}/webhook-test/${WF_PATH}`
    : `${HOOKS_BASE}/webhook/${WF_PATH}`;

  if (isTestMode()) {
    const indicator = document.createElement('div');
    indicator.className = 'test-indicator';
    indicator.textContent = 'TEST MODE';
    document.body.appendChild(indicator);
    console.log('Test mode: Editor live capture enabled');
    console.log('Webhook URL:', WEBHOOK_URL);
  }

  const $ = (s)=>document.querySelector(s);
  const q = $('#q'), btn = $('#send'), res = $('#res'), sendLabel = $('#sendLabel');

  function loading(on){
    if(on){
      btn.disabled = true;
      sendLabel.innerHTML = '<span class="spin"></span>';
      res.innerHTML = '<div class="status"><span class="spin"></span>AI is working…</div>';
    } else {
      btn.disabled = false;
      sendLabel.textContent = 'Send';
    }
  }

  async function postJson(url, body){
    const r = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const text = await r.text();
    let data; try{ data = JSON.parse(text); } catch { data = { raw:text }; }
    return { ok:r.ok, status:r.status, data };
  }

  function looksLikeHtml(s){
    return /^\s*<(?:!DOCTYPE|html|body|main|div|section|article|h1|h2|p|iframe)\b/i.test(s || "");
  }
  function decodeHtmlEntities(str) {
    if (typeof str !== 'string') return str;
    const el = document.createElement("textarea");
    el.innerHTML = str;
    return el.value;
  }
  function extractEmbeddable(htmlString){
    try {
      const s = String(htmlString || "");
      const m = s.match(/^\s*<iframe\b[^>]*\bsrcdoc=(["'])([\s\S]*?)\1[^>]*>\s*<\/iframe>\s*$/i);
      if (m) {
        const ta = document.createElement("textarea");
        ta.innerHTML = m[2];
        return ta.value;
      }
      if (/^\s*<iframe\b/i.test(s)) return s;
      const parser = new DOMParser();
      const doc = parser.parseFromString(s, "text/html");
      const main = doc.querySelector("main");
      if (main) return main.innerHTML;
      if (doc.body) return doc.body.innerHTML || s;
      return s;
    } catch {
      return htmlString;
    }
  }
  function pickHtmlPayload(data, fallback){
    const candidates = [
      data?.html_document, data?.html, data?.content, data?.body,
      data?.answer?.html_document, data?.answer?.html,
      data?.data?.html_document, data?.data?.html,
      data?.json?.html_document, data?.json?.html, fallback
    ].filter(v => typeof v === 'string');

    for (let raw of candidates){
      const dec = /&lt;|&gt;|&amp;|&quot;|&#39;/.test(raw) ? decodeHtmlEntities(raw) : raw;
      if (looksLikeHtml(dec)) return dec;
    }
    return null;
  }

  // edit mode + exports
  let editMode = false;
  const dlHtmlBtn = document.getElementById('downloadHtml');
  const dlPdfBtn  = document.getElementById('downloadPdf');
  const toggleBtn = document.getElementById('toggleEdit');

  function enableExports(on){
    if(!dlHtmlBtn || !dlPdfBtn) return;
    dlHtmlBtn.disabled = !on;
    dlPdfBtn.disabled  = !on;
  }
  function currentResultHTML(){
    const inner = res.innerHTML || '';
    const doc = [
      '<!DOCTYPE html>',
      '<html lang="ko"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>result</title></head><body>',
      inner,
      '</body></html>'
    ].join('');
    return doc;
  }
  function downloadHTMLFile(){
    const content = currentResultHTML();
    const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'result.html';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  function downloadPDFFile(){
    const content = currentResultHTML();
    const w = window.open('', '_blank');
    if(!w){ alert('Allow popups to export PDF.'); return; }
    w.document.open();
    w.document.write(content);
    w.document.close();
    w.focus();
    setTimeout(()=>{ w.print(); }, 150);
  }
  function toggleEditMode(){
    editMode = !editMode;
    res.contentEditable = editMode ? "true" : "false";
    res.classList.toggle('editing', !!editMode);
    toggleBtn.textContent = editMode ? '수정 종료' : '수정 모드';
  }
  if (dlHtmlBtn) dlHtmlBtn.addEventListener('click', downloadHTMLFile);
  if (dlPdfBtn)  dlPdfBtn.addEventListener('click',  downloadPDFFile);
  if (toggleBtn) toggleBtn.addEventListener('click', toggleEditMode);

  // send action
  async function send(){
    const topic = q.value.trim();
    if(topic.length < 2){ q.focus(); res.textContent='Please enter at least 2 characters.'; return; }
    loading(true);
    try{
      const r = await postJson(WEBHOOK_URL, { topic });
      if(!r.ok){
        res.textContent = `HTTP ${r.status}\n` + JSON.stringify(r.data,null,2);
        enableExports(false);
        return;
      }
      const ans = r.data?.answer ?? r.data?.data ?? r.data?.raw ?? r.data ?? { ok:true };
      const html = pickHtmlPayload(r.data, typeof ans==='string' ? ans : '');
      if (html){
        const cleaned = decodeHtmlEntities(html);
        const embeddable = extractEmbeddable(cleaned);
        res.innerHTML = embeddable;
        res.style.whiteSpace = 'normal';
        res.style.textAlign = 'left';
        res.style.display = 'block';
        res.style.minHeight = 'auto';
        res.contentEditable = editMode ? "true" : "false";
        res.classList.toggle('editing', !!editMode);
        enableExports(true);
        return;
      }
      res.textContent = (typeof ans==='string') ? ans : JSON.stringify(ans,null,2);
      enableExports(true);
    }catch(e){
      res.textContent = 'Network error: ' + (e?.message || String(e));
      enableExports(false);
    }finally{ loading(false); }
  }
  btn.addEventListener('click', send);
  q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

  // helpers: rotating 3 topics, clickable
  const helpersEl = document.getElementById('helpers');
  const ROTATE_MS = 12000; // 12s
  let topicPool = [];
  let order = [];
  let cursor = 0;
  let rotateTimer = null;

  function loadTopics(){
    try{
      const raw = document.getElementById('topic-data')?.textContent || '[]';
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr.filter(Boolean) : [];
    }catch{ return []; }
  }
  function shuffle(a){
    const x = a.slice();
    for(let i=x.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [x[i],x[j]] = [x[j],x[i]];
    }
    return x;
  }
  function escHtml(s){
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function escAttr(s){
    return escHtml(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }
  function nextSet(n=3){
    if(cursor >= order.length){
      order = shuffle(order);
      cursor = 0;
    }
    const idxs = order.slice(cursor, cursor+n);
    cursor += n;
    return idxs.map(i => topicPool[i]);
  }
  function renderHelpers(){
    if(!helpersEl) return;
    const items = nextSet(3);
    helpersEl.innerHTML = items.map(t =>
      `<button class="helper" data-text="${escAttr(t)}">${escHtml(t)}</button>`
    ).join('');
  }
  function startRotate(){
    if(rotateTimer) clearInterval(rotateTimer);
    rotateTimer = setInterval(renderHelpers, ROTATE_MS);
  }
  function initHelpers(){
    topicPool = loadTopics();
    order = topicPool.map((_,i)=>i);
    order = shuffle(order);
    cursor = 0;
    renderHelpers();
    startRotate();
  }
  // click-to-send (event delegation)
  if (helpersEl){
    helpersEl.addEventListener('click', (e)=>{
      const btnEl = e.target.closest('.helper');
      if(!btnEl) return;
      const text = btnEl.getAttribute('data-text') || btnEl.textContent || '';
      q.value = text;
      send();
    });
  }

  // Kakao link generator
  (function(){
    const BASE = 'https://hooks.xn--h32b21du9cf7grcy2k20f.com/webhook/kakao-redirect';
    const key = document.getElementById('k-key');
    const btnMake = document.getElementById('k-make');
    const btnCopy = document.getElementById('k-copy');
    const out = document.getElementById('k-result');

    function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,10); }
    function build(){
      const kw = (key.value || '').trim();
      if(!kw){
        out.textContent = '키워드를 입력하세요';
        out.classList.add('placeholder');
        return;
      }
      const u = uid();
      const qs = new URLSearchParams({ ref: kw, utm_content: u }).toString();
      const url = BASE + (BASE.includes('?') ? '&' : '?') + qs;
      out.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${url}</a>`;
      out.classList.remove('placeholder');
    }
    async function copy(){
      const a = out.querySelector('a');
      const url = a ? a.href : (out.textContent || '').trim();
      if(!/^https?:\/\//.test(url)){
        out.textContent = '먼저 링크를 생성하세요';
        out.classList.add('placeholder');
        return;
      }
      try{
        await navigator.clipboard.writeText(url);
        btnCopy.textContent = '복사 완료 ✅';
        setTimeout(()=>{ btnCopy.textContent = '복사 📋'; }, 1200);
      }catch{
        const t = document.createElement('textarea');
        t.value = url; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
        btnCopy.textContent = '복사 완료 ✅';
        setTimeout(()=>{ btnCopy.textContent = '복사 📋'; }, 1200);
      }
    }
    if (btnMake) btnMake.addEventListener('click', build);
    if (btnCopy) btnCopy.addEventListener('click', copy);
    if (key) key.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); build(); }});
  })();

  // boot
  document.addEventListener('DOMContentLoaded', initHelpers);
</script>
</body>
</html>
